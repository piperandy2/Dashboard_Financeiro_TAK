<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Financeiro</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    body { margin:0; font-family:Inter,Arial,sans-serif; background:#f5f7fb; color:#1f2937; }
    .container { padding:24px; max-width:1400px; margin:auto; }
    h1 { font-size:24px; margin-bottom:8px; }
    h2 { font-size:14px; color:#6b7280; margin:16px 0 12px; }
    .controls { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; gap:16px; }
    .month-controls { display:flex; align-items:center; gap:12px; }
    .quick-months { display:flex; gap:6px; }
    .month-chip {
      padding:4px 10px;
      font-size:12px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
      cursor:pointer;
      user-select:none;
    }
    .month-chip.active { background:#059669; color:#fff; }

    .upload-btn {
      position:relative;
      overflow:hidden;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border-radius:10px;
      background:#ffffff;
      border:1px solid #d1d5db;
      font-size:13px;
      cursor:pointer;
    }
    .upload-btn svg { width:16px; height:16px; stroke:#374151; }
    .upload-btn input { position:absolute; inset:0; opacity:0; cursor:pointer; }

    .grid-4 { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:24px; }
    .grid-2 { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; margin-bottom:24px; }
    .chart-card { height:180px; padding:12px; }
    .chart-inner { width:100%; height:100%; }
    .card { background:#fff; border-radius:14px; padding:16px; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
    .card-title { font-size:12px; color:#6b7280; margin-bottom:6px; }
    .card-value { font-size:26px; font-weight:700; }

    .metric-icon {
      width:40px; height:40px;
      border-radius:12px;
      background:#ecfdf5;
      display:flex; align-items:center; justify-content:center;
    }
    .metric-icon svg { width:20px; height:20px; stroke:#059669; fill:none; stroke-width:2; }

    .delta { display:inline-flex; align-items:center; gap:4px; font-size:12px; font-weight:500; padding:2px 8px; border-radius:999px; }
    .delta.up { background:#ecfdf5; color:#059669; }
    .delta.down { background:#fef2f2; color:#dc2626; }

    select,input { padding:6px 10px; border-radius:8px; border:1px solid #d1d5db; }
  </style>
</head>
<body>
<div class="container">
  <h1>Dashboard Financeiro</h1>

  <div class="controls">
    <div class="month-controls">
      <div>
        <label>Mês:&nbsp;</label>
        <select id="monthSelect"></select>
      </div>
      <div class="quick-months" id="quickMonths"></div>
    </div>

    <label class="upload-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
        <path d="M12 3v12" />
        <path d="M7 8l5-5 5 5" />
        <path d="M5 21h14" />
      </svg>
      Upload JSON
      <input type="file" id="fileInput" accept="application/json" />
    </label>
  </div>

  <div class="grid-4" id="topKPIs"></div>

  <div class="grid-2">
    <div class="card chart-card"><div id="areaRevenue" class="chart-inner"></div></div>
    <div class="card chart-card"><div id="areaCosts" class="chart-inner"></div></div>
  </div>

  <h2>STONE</h2>
  <div class="grid-4" id="stoneKPIs"></div>

  <h2>SALDOS</h2>
  <div class="grid-4" id="bottomKPIs"></div>
</div>

<!-- Embedded JSON so the dashboard works 100% offline (file://) -->
<script id="preloaded-json" type="application/json">
PASTE_YOUR_JSON_HERE
</script>

<script>
let raw = [];
let months = [];
let currentMonth = '';

function parseValue(v){
  if(typeof v === 'number') return v;
  if(typeof v === 'string'){
    if(v.includes('%')) return parseFloat(v.replace(',','.'));
    return parseFloat(v.replace(/R\$|\.|\s/g,'').replace(',','.')) || 0;
  }
  return 0;
}

function getCat(name){ return raw.find(r => r.Categoria === name); }

function init(json){
  raw = json || [];
  if(!raw.length) return;
  const sample = raw[0];
  months = Object.keys(sample).filter(k => k !== 'Categoria');
  currentMonth = months[months.length - 1];
  populateMonths();
  render();
}

function populateMonths(){
  const sel = document.getElementById('monthSelect');
  const quick = document.getElementById('quickMonths');
  sel.innerHTML = '';
  quick.innerHTML = '';

  months.forEach(m => {
    const o = document.createElement('option');
    o.value = m; o.textContent = m;
    if(m === currentMonth) o.selected = true;
    sel.appendChild(o);
  });

  months.slice(-3).forEach(m => {
    const chip = document.createElement('div');
    chip.className = 'month-chip' + (m === currentMonth ? ' active' : '');
    chip.textContent = m;
    chip.onclick = () => { currentMonth = m; populateMonths(); render(); };
    quick.appendChild(chip);
  });

  sel.onchange = e => { currentMonth = e.target.value; populateMonths(); render(); };
}

function render(){
  renderCards('topKPIs', [
    ['RECEITAS','Receitas'],
    ['DESPESAS','Despesas'],
    ['SALDO DO PERÍODO','Saldo Mês'],
    ['LUCRO LIQUIDO','Lucro %']
  ]);

  renderArea('areaRevenue','Faturamento',[
    'FATURAMENTO DE CONSULTAS','FATURAMENTO INJETAVEIS'
  ], ['Consultas','Injetáveis']);

  renderArea('areaCosts','Custos',[
    'CUSTOS FIXOS TOTAL','CUSTOS VARIÁVEIS TOTAL'
  ], ['Fixos','Variáveis']);

  renderCards('stoneKPIs', [
    ['VENDA TOTAL - STONE','Vendas Stone'],
    ['NÚMERO VENDAS - STONE','Qtd Vendas Stone'],
    ['TICKET MÉDIO - STONE','Ticket Médio Stone'],
    ['SALDO INICIAL STONE','Saldo Inicial Stone']
  ]);

  renderCards('bottomKPIs', [
    ['SALDO DO PERÍODO','Saldo Mês'],
    ['SALDO FINAL UNICRED','Saldo Final Unicred'],
    ['SALDO FINAL STONE','Saldo Final Stone'],
    ['CAIXINHA','Caixinha']
  ]);
}

function renderCards(containerId, defs){
  const c = document.getElementById(containerId); c.innerHTML = '';
  defs.forEach(([key,label]) => {
    const row = getCat(key); if(!row) return;
    const values = months.map(m => parseValue(row[m]));
    const i = months.indexOf(currentMonth);
    const cur = values[i]; const prev = values[i-1] ?? cur;
    const diff = prev ? ((cur - prev) / prev) * 100 : 0;
    const up = diff >= 0;

    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class='card-title'>${label}</div>
      <div class='card-value'>${row[currentMonth]}</div>
      <span class='delta ${up ? 'up':'down'}'>${up?'▲':'▼'} ${Math.abs(diff).toFixed(1)}%</span>
    `;
    c.appendChild(card);
  });
}

function renderArea(divId, title, keys, names){
  const traces = keys.map((k,i) => {
    const row = getCat(k);
    return {
      x: months,
      y: months.map(m => parseValue(row[m])),
      type:'scatter',
      mode:'lines',
      name:names[i],
      stackgroup:'one',
      fill: i===0 ? 'tozeroy' : 'tonexty'
    };
  });

  Plotly.newPlot(divId, traces, {
    title,
    margin:{t:40,l:40,r:20,b:30},
    legend:{orientation:'h',y:-0.25}
  }, {responsive:true,displayModeBar:false});
}

fileInput.addEventListener('change', e => {
  const r = new FileReader();
  r.onload = ev => init(JSON.parse(ev.target.result));
  r.readAsText(e.target.files[0]);
});

// Always initialize from embedded JSON so it works locally without fetch
try {
  const embedded = document.getElementById('preloaded-json').textContent.trim();
  if(embedded && !embedded.includes('PASTE_YOUR_JSON_HERE')){
    init(JSON.parse(embedded));
  }
} catch(e) {}
</script>
</body>
</html>
